<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Puertas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
        }

        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: white !important;
        }

        .page-header {
            background: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--light-bg);
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
        }

        .page-subtitle {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 1.25rem;
            border-radius: 8px 8px 0 0;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .badge-entrada {
            background-color: var(--success-color);
        }

        .badge-salida {
            background-color: var(--warning-color);
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background-color: var(--light-bg);
            color: var(--primary-color);
            border: none;
            font-weight: 600;
            padding: 1rem;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #e0e0e0;
        }

        .table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid #ddd;
            padding: 0.625rem 0.875rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .alert {
            border: none;
            border-radius: 8px;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner-border {
            color: var(--secondary-color);
        }

        .estado-pendiente {
            background-color: #fff3cd;
            color: #856404;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .estado-autorizado {
            background-color: #d4edda;
            color: #155724;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .estado-completado {
            background-color: #d4edda;
            color: #155724;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .estado-rechazado {
            background-color: #f8d7da;
            color: #721c24;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .acciones {
            display: flex;
            gap: 0.5rem;
        }

        .acciones .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.85rem;
        }

        .tab-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--light-bg);
        }

        .nav-tabs .nav-link {
            color: #7f8c8d;
            border: none;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .nav-tabs .nav-link:hover {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .nav-tabs .nav-link.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .stats-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .stats-card .label {
            color: #7f8c8d;
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        .active-badge {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success-color);
            margin-right: 0.5rem;
        }

        .inactive-badge {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #bdc3c7;
            margin-right: 0.5rem;
        }

        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 3rem;
            color: #bdc3c7;
            margin-bottom: 1rem;
            display: block;
        }

        .empty-state h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .selection-card {
            background: white;
            border-radius: 15px;
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .selection-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 0;
        }

        .entrada-card::before {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(34, 153, 84, 0.1) 100%);
        }

        .salida-card::before {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1) 0%, rgba(230, 126, 34, 0.1) 100%);
        }

        .selection-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .selection-card:hover::before {
            opacity: 1;
        }

        .entrada-card {
            border-top: 5px solid var(--success-color);
        }

        .salida-card {
            border-top: 5px solid var(--warning-color);
        }

        .selection-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .entrada-card .selection-icon {
            color: var(--success-color);
        }

        .salida-card .selection-icon {
            color: var(--warning-color);
        }

        .selection-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-color);
            position: relative;
            z-index: 1;
        }

        .selection-description {
            color: #7f8c8d;
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .selection-badge {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }

        .entrada-card .selection-badge {
            background-color: var(--success-color);
            color: white;
        }

        .salida-card .selection-badge {
            background-color: var(--warning-color);
            color: white;
        }

        .quick-stat {
            padding: 1rem;
        }

        .quick-stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .quick-stat-label {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        a.text-decoration-none:hover {
            text-decoration: none !important;
        }

        .btn-outline-secondary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-outline-secondary:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
    <link rel="stylesheet" href="/static/modules-base.css">
    <link rel="stylesheet" href="/static/components-advanced.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/app/erp">
                <i class="fas fa-warehouse"></i> OmniERP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/app/erp">
                            <i class="fas fa-home"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container-fluid">
            <h1 class="page-title">
                <i class="fas fa-door-open"></i> Gestión de Puertas
            </h1>
            <p class="page-subtitle">Controla las entradas y salidas del almacén</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Alert Area -->
        <div id="alertArea"></div>

        <!-- Selection Screen -->
        <div class="row justify-content-center" style="margin-top: 3rem;">
            <div class="col-lg-10">
                <div class="text-center mb-5">
                    <h2 style="color: var(--primary-color); font-size: 2.5rem; margin-bottom: 1rem;">
                        Selecciona el Tipo de Puerta
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 1.2rem;">
                        Elige la operación que deseas realizar
                    </p>
                </div>

                <div class="row g-4">
                    <!-- Puerta de Entrada -->
                    <div class="col-md-6">
                        <a href="/app/puertas/entrada" class="text-decoration-none">
                            <div class="selection-card entrada-card">
                                <div class="selection-icon">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <h3 class="selection-title">Puerta de Entrada</h3>
                                <p class="selection-description">
                                    Recepción de material:<br>
                                    • Órdenes de Compra<br>
                                    • Devoluciones Autorizadas<br>
                                    • Producción Externa
                                </p>
                                <div class="selection-badge">
                                    <span id="pendientesEntrada">0</span> Pendientes
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Puerta de Salida -->
                    <div class="col-md-6">
                        <a href="/app/puertas/salida" class="text-decoration-none">
                            <div class="selection-card salida-card">
                                <div class="selection-icon">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                                <h3 class="selection-title">Puerta de Salida</h3>
                                <p class="selection-description">
                                    Expedición de material:<br>
                                    • Órdenes de Venta<br>
                                    • Transferencias<br>
                                    • Devoluciones a Proveedor
                                </p>
                                <div class="selection-badge">
                                    <span id="pendientesSalida">0</span> Pendientes
                                </div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row mt-5">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar"></i> Resumen Rápido
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-number" id="totalPuertas">0</div>
                                            <div class="quick-stat-label">Puertas Configuradas</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-number" id="movimientosHoy">0</div>
                                            <div class="quick-stat-label">Movimientos Hoy</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-number" id="movimientosPendientes">0</div>
                                            <div class="quick-stat-label">Total Pendientes</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Section -->
                <div class="row mt-4">
                    <div class="col-md-12 text-center">
                        <button class="btn btn-outline-secondary" onclick="showAdminPanel()">
                            <i class="fas fa-cog"></i> Configurar Puertas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanel" style="display: none; margin-top: 3rem;">
            <!-- Stats Row -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="number" id="totalPuertasAdmin">0</div>
                        <div class="label">Puertas Total</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="number" id="totalEntradas">0</div>
                        <div class="label">Puertas de Entrada</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="number" id="totalSalidas">0</div>
                        <div class="label">Puertas de Salida</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="number" id="movimientosPendientesAdmin">0</div>
                        <div class="label">Movimientos Pendientes</div>
                    </div>
                </div>
            </div>

            <div class="text-center mb-3">
                <button class="btn btn-primary" onclick="hideAdminPanel()">
                    <i class="fas fa-arrow-left"></i> Volver a Selección
                </button>
            </div>

        <!-- Main Tabs -->
        <div>
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#puertas-tab">
                        <i class="fas fa-door-open"></i> Puertas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#movimientos-tab">
                        <i class="fas fa-exchange-alt"></i> Movimientos
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Puertas Tab -->
                <div id="puertas-tab" class="tab-pane active">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgregarPuerta">
                                <i class="fas fa-plus"></i> Agregar Nueva Puerta
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="filter-section">
                        <div class="filter-group">
                            <label for="filterTipo">Tipo de Puerta:</label>
                            <select id="filterTipo" class="form-select">
                                <option value="">Todas</option>
                                <option value="entrada">Entradas</option>
                                <option value="salida">Salidas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterEstatus">Estado:</label>
                            <select id="filterEstatus" class="form-select">
                                <option value="">Todas</option>
                                <option value="1">Activas</option>
                                <option value="0">Inactivas</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="cargarPuertas()">
                            <i class="fas fa-refresh"></i> Actualizar
                        </button>
                    </div>

                    <!-- Puertas Table -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Ubicación</th>
                                    <th>Responsable</th>
                                    <th>Estado</th>
                                    <th>Autorización</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="puertas-table">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <div class="loading active">
                                            <div class="spinner-border" role="status"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Movimientos Tab -->
                <div id="movimientos-tab" class="tab-pane">
                    <!-- Filters -->
                    <div class="filter-section">
                        <div class="filter-group">
                            <label for="filterPuerta">Puerta:</label>
                            <select id="filterPuerta" class="form-select">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterEstadoMov">Estado:</label>
                            <select id="filterEstadoMov" class="form-select">
                                <option value="">Todos</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="autorizado">Autorizado</option>
                                <option value="completado">Completado</option>
                                <option value="rechazado">Rechazado</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="cargarMovimientos()">
                            <i class="fas fa-refresh"></i> Actualizar
                        </button>
                    </div>

                    <!-- Movimientos Table -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Puerta</th>
                                    <th>Usuario</th>
                                    <th>Documento</th>
                                    <th>Descripción</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="movimientos-table">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <div class="loading active">
                                            <div class="spinner-border" role="status"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End Admin Panel -->
    </div>

    <!-- Modal Agregar/Editar Puerta -->
    <div class="modal fade" id="modalAgregarPuerta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Agregar Nueva Puerta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formPuerta">
                        <div class="mb-3">
                            <label for="codigo" class="form-label">Código *</label>
                            <input type="text" class="form-control" id="codigo" required>
                        </div>
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="tipo" class="form-label">Tipo *</label>
                            <select class="form-select" id="tipo" required>
                                <option value="entrada">Entrada</option>
                                <option value="salida">Salida</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ubicacion" class="form-label">Ubicación</label>
                            <input type="text" class="form-control" id="ubicacion">
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="responsable_nombre" class="form-label">Responsable</label>
                            <input type="text" class="form-control" id="responsable_nombre">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requiere_autorizacion" checked>
                                <label class="form-check-label" for="requiere_autorizacion">
                                    Requiere autorización
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="es_activa" checked>
                                <label class="form-check-label" for="es_activa">
                                    Puerta activa
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="horario_apertura" class="form-label">Hora de Apertura</label>
                                    <input type="time" class="form-control" id="horario_apertura">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="horario_cierre" class="form-label">Hora de Cierre</label>
                                    <input type="time" class="form-control" id="horario_cierre">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarPuerta()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div class="modal fade" id="modalDetalles" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de la Puerta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detallesContent">
                    <div class="loading active">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Movimiento -->
    <div class="modal fade" id="modalRegistrarMovimiento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Movimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMovimiento">
                        <input type="hidden" id="movPuertaId">
                        <div class="mb-3">
                            <label for="movUsuario" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="movUsuario">
                        </div>
                        <div class="mb-3">
                            <label for="movDocumento" class="form-label">Referencia de Documento</label>
                            <input type="text" class="form-control" id="movDocumento">
                        </div>
                        <div class="mb-3">
                            <label for="movTipo" class="form-label">Tipo de Documento</label>
                            <select class="form-select" id="movTipo">
                                <option value="">Seleccione...</option>
                                <option value="orden_compra">Orden de Compra</option>
                                <option value="orden_venta">Orden de Venta</option>
                                <option value="orden_produccion">Orden de Producción</option>
                                <option value="transfer">Transferencia</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="movCantidad" class="form-label">Cantidad de Items</label>
                            <input type="number" class="form-control" id="movCantidad" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="movDescripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="movDescripcion" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarMovimiento()">Registrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function verificarModuloRecepcion() {
            try {
                const resp = await fetch('/api/organization/modules-config', {
                    headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') }
                });
                if (!resp.ok) return;
                const data = await resp.json();
                const enabled = data.enabled_modules || [];
                const activo = enabled.includes('recepcion');
                const msg = document.getElementById('moduleDisabledMsg');
                if (!activo) {
                    msg.style.display = 'block';
                    const selectors = [
                        '.card', '.table-responsive', '.alert-info'
                    ];
                    selectors.forEach(sel => document.querySelectorAll(sel).forEach(el => el.style.display = 'none'));
                }
            } catch (e) {
                console.warn('No se pudo verificar módulos');
            }
        }
        const API_BASE = "/api/puertas";
        let puertas = [];
        let movimientos = [];
        let currentPuertaEditId = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            verificarModuloRecepcion();
            cargarEstadisticasRapidas();
        });

        // Show/hide admin panel
        function showAdminPanel() {
            document.getElementById('adminPanel').style.display = 'block';
            document.querySelector('.row.justify-content-center').style.display = 'none';
            cargarPuertas();
            cargarMovimientos();
            actualizarEstadisticasAdmin();
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            document.querySelector('.row.justify-content-center').style.display = 'block';
            cargarEstadisticasRapidas();
        }

        // Load quick stats for selection screen
        async function cargarEstadisticasRapidas() {
            try {
                const response = await fetch(API_BASE);
                const puertas = await response.json();
                
                document.getElementById('totalPuertas').textContent = puertas.length;
                document.getElementById('totalPuertasAdmin').textContent = puertas.length;
                
                // Cargar pendientes de entrada
                try {
                    const respEntrada = await fetch(`${API_BASE}/entrada/pendientes`);
                    const pendientesEntrada = await respEntrada.json();
                    document.getElementById('pendientesEntrada').textContent = pendientesEntrada.length;
                } catch (e) {
                    document.getElementById('pendientesEntrada').textContent = '0';
                }
                
                // TODO: Cargar pendientes de salida cuando esté implementado
                document.getElementById('pendientesSalida').textContent = '0';
                
                // Movimientos hoy y pendientes
                document.getElementById('movimientosHoy').textContent = '0';
                document.getElementById('movimientosPendientes').textContent = '0';
                
            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
            }
        }

        // Rename old stats function
        function actualizarEstadisticasAdmin() {
            actualizarEstadisticas();
        }

        // Filter listeners
        document.getElementById('filterTipo').addEventListener('change', cargarPuertas);
        document.getElementById('filterEstatus').addEventListener('change', cargarPuertas);
        document.getElementById('filterPuerta').addEventListener('change', cargarMovimientos);
        document.getElementById('filterEstadoMov').addEventListener('change', cargarMovimientos);

        // Load Puertas
        async function cargarPuertas() {
            const tipo = document.getElementById('filterTipo').value;
            const estatus = document.getElementById('filterEstatus').value;

            let url = API_BASE;
            const params = new URLSearchParams();
            if (tipo) params.append('tipo', tipo);
            if (estatus !== '') params.append('es_activa', estatus === '1');

            if (params.toString()) {
                url += '?' + params.toString();
            }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Error al cargar puertas');
                puertas = await response.json();
                renderPuertas();
                actualizarEstadisticas();
                actualizarFiltrosPuertas();
            } catch (error) {
                showAlert('Error al cargar las puertas: ' + error.message, 'danger');
            }
        }

        // Render Puertas
        function renderPuertas() {
            const tbody = document.getElementById('puertas-table');
            if (puertas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="fas fa-door-open"></i>
                                <h3>No hay puertas registradas</h3>
                                <p>Comienza agregando una puerta de entrada o salida</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = puertas.map(puerta => {
                const tipoBadge = puerta.tipo === 'entrada' 
                    ? '<span class="badge badge-entrada"><i class="fas fa-arrow-right"></i> Entrada</span>'
                    : '<span class="badge badge-salida"><i class="fas fa-arrow-left"></i> Salida</span>';
                
                const estadoBadge = puerta.es_activa
                    ? '<span class="badge bg-success">Activa</span>'
                    : '<span class="badge bg-secondary">Inactiva</span>';

                const autBadge = puerta.requiere_autorizacion
                    ? '<span class="badge bg-info">Sí</span>'
                    : '<span class="badge bg-secondary">No</span>';

                return `
                    <tr>
                        <td><strong>${puerta.codigo}</strong></td>
                        <td>${puerta.nombre}</td>
                        <td>${tipoBadge}</td>
                        <td>${puerta.ubicacion || '-'}</td>
                        <td>${puerta.responsable_nombre || '-'}</td>
                        <td>${estadoBadge}</td>
                        <td>${autBadge}</td>
                        <td>
                            <div class="acciones">
                                <button class="btn btn-sm btn-info" onclick="verDetalles(${puerta.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editarPuerta(${puerta.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="registrarMovimientoPuerta(${puerta.id})">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarPuerta(${puerta.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load Movimientos
        async function cargarMovimientos() {
            const puertaId = document.getElementById('filterPuerta').value;
            const estado = document.getElementById('filterEstadoMov').value;

            // Si no hay puerta seleccionada, cargar todos
            let url = puertaId ? `${API_BASE}/${puertaId}/movimientos` : `${API_BASE}/movimientos/pendientes`;
            
            const params = new URLSearchParams();
            if (estado) params.append('estado', estado);

            if (params.toString()) {
                url += '?' + params.toString();
            }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Error al cargar movimientos');
                movimientos = await response.json();
                renderMovimientos();
                actualizarEstadisticas();
            } catch (error) {
                console.log('Info: No hay filtro de puerta seleccionado o error menor');
            }
        }

        // Render Movimientos
        function renderMovimientos() {
            const tbody = document.getElementById('movimientos-table');
            if (movimientos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h3>No hay movimientos</h3>
                                <p>Los movimientos aparecerán aquí</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = movimientos.map(mov => {
                const fecha = new Date(mov.creado_en).toLocaleString('es-ES');
                const estadoClass = `estado-${mov.estado}`;
                
                return `
                    <tr>
                        <td><small>${fecha}</small></td>
                        <td>${mov.puerta_id}</td>
                        <td>${mov.usuario_nombre || '-'}</td>
                        <td>${mov.referencia_documento || '-'}</td>
                        <td>${mov.descripcion || '-'}</td>
                        <td><div class="${estadoClass}">${mov.estado}</div></td>
                        <td>
                            <div class="acciones">
                                <button class="btn btn-sm btn-info" onclick="verDetallesMovimiento(${mov.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${mov.estado === 'pendiente' ? `
                                    <button class="btn btn-sm btn-success" onclick="autorizarMovimiento(${mov.id}, 'autorizado')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="autorizarMovimiento(${mov.id}, 'rechazado')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Guardar Puerta
        async function guardarPuerta() {
            const form = document.getElementById('formPuerta');
            
            const data = {
                codigo: document.getElementById('codigo').value,
                nombre: document.getElementById('nombre').value,
                tipo: document.getElementById('tipo').value,
                ubicacion: document.getElementById('ubicacion').value,
                descripcion: document.getElementById('descripcion').value,
                responsable_nombre: document.getElementById('responsable_nombre').value,
                requiere_autorizacion: document.getElementById('requiere_autorizacion').checked,
                es_activa: document.getElementById('es_activa').checked,
                horario_apertura: document.getElementById('horario_apertura').value || null,
                horario_cierre: document.getElementById('horario_cierre').value || null,
            };

            try {
                const url = currentPuertaEditId 
                    ? `${API_BASE}/${currentPuertaEditId}`
                    : API_BASE;
                
                const method = currentPuertaEditId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Error al guardar');
                }

                showAlert(currentPuertaEditId ? 'Puerta actualizada' : 'Puerta creada', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalAgregarPuerta')).hide();
                form.reset();
                currentPuertaEditId = null;
                document.getElementById('modalTitle').textContent = 'Agregar Nueva Puerta';
                cargarPuertas();
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Editar Puerta
        async function editarPuerta(id) {
            const puerta = puertas.find(p => p.id === id);
            if (!puerta) return;

            currentPuertaEditId = id;
            document.getElementById('modalTitle').textContent = 'Editar Puerta';
            document.getElementById('codigo').value = puerta.codigo;
            document.getElementById('codigo').disabled = true;
            document.getElementById('nombre').value = puerta.nombre;
            document.getElementById('tipo').value = puerta.tipo;
            document.getElementById('ubicacion').value = puerta.ubicacion || '';
            document.getElementById('descripcion').value = puerta.descripcion || '';
            document.getElementById('responsable_nombre').value = puerta.responsable_nombre || '';
            document.getElementById('requiere_autorizacion').checked = puerta.requiere_autorizacion;
            document.getElementById('es_activa').checked = puerta.es_activa;
            document.getElementById('horario_apertura').value = puerta.horario_apertura || '';
            document.getElementById('horario_cierre').value = puerta.horario_cierre || '';

            new bootstrap.Modal(document.getElementById('modalAgregarPuerta')).show();
        }

        // Eliminar Puerta
        async function eliminarPuerta(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta puerta?')) return;

            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Error al eliminar');
                
                showAlert('Puerta eliminada', 'success');
                cargarPuertas();
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Ver Detalles
        async function verDetalles(id) {
            const content = document.getElementById('detallesContent');
            content.innerHTML = '<div class="loading active"><div class="spinner-border" role="status"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/${id}`);
                if (!response.ok) throw new Error('Error al cargar');
                const puerta = await response.json();

                content.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Código:</strong> ${puerta.codigo}
                        </div>
                        <div class="col-md-6">
                            <strong>Nombre:</strong> ${puerta.nombre}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Tipo:</strong> ${puerta.tipo === 'entrada' ? 'Entrada' : 'Salida'}
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong> ${puerta.es_activa ? 'Activa' : 'Inactiva'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Ubicación:</strong> ${puerta.ubicacion || '-'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Descripción:</strong> ${puerta.descripcion || '-'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Responsable:</strong> ${puerta.responsable_nombre || '-'}
                        </div>
                        <div class="col-md-6">
                            <strong>Requiere Autorización:</strong> ${puerta.requiere_autorizacion ? 'Sí' : 'No'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Hora Apertura:</strong> ${puerta.horario_apertura || '-'}
                        </div>
                        <div class="col-md-6">
                            <strong>Hora Cierre:</strong> ${puerta.horario_cierre || '-'}
                        </div>
                    </div>
                `;

                new bootstrap.Modal(document.getElementById('modalDetalles')).show();
            } catch (error) {
                content.innerHTML = '<div class="alert alert-danger">Error al cargar detalles</div>';
            }
        }

        // Registrar Movimiento
        function registrarMovimientoPuerta(puertaId) {
            document.getElementById('movPuertaId').value = puertaId;
            document.getElementById('formMovimiento').reset();
            new bootstrap.Modal(document.getElementById('modalRegistrarMovimiento')).show();
        }

        // Guardar Movimiento
        async function guardarMovimiento() {
            const puertaId = document.getElementById('movPuertaId').value;
            const data = {
                puerta_id: parseInt(puertaId),
                usuario_nombre: document.getElementById('movUsuario').value,
                referencia_documento: document.getElementById('movDocumento').value,
                tipo_documento: document.getElementById('movTipo').value,
                cantidad_items: document.getElementById('movCantidad').value ? parseInt(document.getElementById('movCantidad').value) : null,
                descripcion: document.getElementById('movDescripcion').value
            };

            try {
                const response = await fetch(`${API_BASE}/${puertaId}/movimientos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Error al registrar');
                }

                showAlert('Movimiento registrado', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalRegistrarMovimiento')).hide();
                cargarMovimientos();
                actualizarEstadisticas();
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Ver Detalles Movimiento
        async function verDetallesMovimiento(id) {
            const content = document.getElementById('detallesContent');
            content.innerHTML = '<div class="loading active"><div class="spinner-border" role="status"></div></div>';

            try {
                const response = await fetch(`${API_BASE}/movimientos/${id}`);
                if (!response.ok) throw new Error('Error al cargar');
                const mov = await response.json();

                content.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Fecha:</strong> ${new Date(mov.creado_en).toLocaleString('es-ES')}
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong> <div class="estado-${mov.estado}">${mov.estado}</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Usuario:</strong> ${mov.usuario_nombre || '-'}
                        </div>
                        <div class="col-md-6">
                            <strong>Documento:</strong> ${mov.referencia_documento || '-'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Descripción:</strong> ${mov.descripcion || '-'}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Cantidad Items:</strong> ${mov.cantidad_items || '-'}
                        </div>
                        <div class="col-md-6">
                            <strong>Tipo Documento:</strong> ${mov.tipo_documento || '-'}
                        </div>
                    </div>
                    ${mov.autorizado_por_nombre ? `
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <strong>Autorizado por:</strong> ${mov.autorizado_por_nombre}
                            </div>
                        </div>
                    ` : ''}
                `;

                new bootstrap.Modal(document.getElementById('modalDetalles')).show();
            } catch (error) {
                content.innerHTML = '<div class="alert alert-danger">Error al cargar detalles</div>';
            }
        }

        // Autorizar Movimiento
        async function autorizarMovimiento(id, nuevoEstado) {
            const mov = movimientos.find(m => m.id === id);
            if (!mov) return;

            try {
                const response = await fetch(`${API_BASE}/${mov.puerta_id}/movimientos/${id}/autorizar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        autorizado_por_id: 1,
                        autorizado_por_nombre: 'Sistema',
                        estado: nuevoEstado
                    })
                });

                if (!response.ok) throw new Error('Error al autorizar');

                showAlert(`Movimiento ${nuevoEstado}`, 'success');
                cargarMovimientos();
                actualizarEstadisticas();
            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            }
        }

        // Actualizar Filtros de Puertas
        function actualizarFiltrosPuertas() {
            const select = document.getElementById('filterPuerta');
            select.innerHTML = '<option value="">Todas</option>';
            puertas.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.codigo} - ${p.nombre}`;
                select.appendChild(option);
            });
        }

        // Actualizar Estadísticas
        async function actualizarEstadisticas() {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();
                
                const total = data.length;
                const entradas = data.filter(p => p.tipo === 'entrada').length;
                const salidas = data.filter(p => p.tipo === 'salida').length;

                document.getElementById('totalPuertas').textContent = total;
                document.getElementById('totalEntradas').textContent = entradas;
                document.getElementById('totalSalidas').textContent = salidas;

                // Contar movimientos pendientes (esto requeriría un endpoint específico)
                document.getElementById('movimientosPendientes').textContent = movimientos.filter(m => m.estado === 'pendiente').length;
            } catch (error) {
                console.error('Error al actualizar estadísticas:', error);
            }
        }

        // Show Alert
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            const alertId = 'alert-' + Date.now();
            
            alertArea.innerHTML += `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            setTimeout(() => {
                const el = document.getElementById(alertId);
                if (el) el.remove();
            }, 5000);
        }

        // Logout
        function logout() {
            window.location.href = '/auth/logout';
        }

        // Reset form on modal close
        document.getElementById('modalAgregarPuerta').addEventListener('hidden.bs.modal', function() {
            document.getElementById('formPuerta').reset();
            document.getElementById('codigo').disabled = false;
            currentPuertaEditId = null;
            document.getElementById('modalTitle').textContent = 'Agregar Nueva Puerta';
        });
    </script>
</body>
</html>
