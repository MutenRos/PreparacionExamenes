<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <title>Reportes y An√°liticas - OmniERP</title>
    <link rel="stylesheet" href="/static/global.css">
    <link rel="stylesheet" href="/static/components.css">
    <link rel="stylesheet" href="/static/aaaaa-animations.css">
    <link rel="stylesheet" href="/static/assistant.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .reportes-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Deja espacio para los paneles de asistencia/soporte fijados en los laterales */
        @media (min-width: 1200px) {
            body {
                padding-left: 280px;
                padding-right: 320px;
            }
            .reportes-container {
                padding-left: 0;
                padding-right: 0;
            }
        }
        @media (max-width: 1199px) {
            body {
                padding: 16px;
            }
        }

        .reportes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 15px;
        }

        .reportes-header h1 {
            margin: 0;
            color: var(--gray-800);
        }

        .filtros {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filtros select, .filtros input {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 14px;
        }

        .filtros button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .filtros button:hover {
            background-color: #0056b3;
        }

        .indices-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .indice-card {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .indice-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .indice-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .indice-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .indice-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .indice-valor {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .indice-cambio {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-top: 0;
            color: var(--gray-800);
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .table-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-card h3 {
            margin-top: 0;
            color: var(--gray-800);
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .table-card table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table-card th {
            background-color: var(--gray-100);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--gray-300);
            color: var(--gray-800);
        }

        .table-card td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .table-card tr:hover {
            background-color: var(--gray-100);
        }

        /* Tabs para tablas */
        .table-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .table-tabs button {
            border: 1px solid var(--gray-300);
            background: #f8fafc;
            color: var(--gray-700);
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .table-tabs button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 6px rgba(0,123,255,0.25);
        }
        .table-panel {
            display: none;
            margin-top: 10px;
        }
        .table-panel.active {
            display: block;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-excelente {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-bueno {
            background-color: #cce5ff;
            color: #004085;
        }

        .badge-alerta {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-critico {
            background-color: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-600);
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .indices-row {
                grid-template-columns: 1fr;
            }

            .reportes-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .filtros {
                flex-wrap: wrap;
                width: 100%;
            }

            .filtros select, .filtros input {
                flex: 1;
                min-width: 150px;
            }
        }
    </style>
    <link rel="stylesheet" href="/static/modules-base.css">
    <link rel="stylesheet" href="/static/components-advanced.css">
</head>
<body>
    <link rel="stylesheet" href="/static/assistant.css">
    <nav class="navbar">
        <div class="nav-container">
            <a href="/dashboard" class="nav-logo">‚ö° OmniERP</a>
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="nav-menu" id="navMenu">
                <a href="/dashboard">Dashboard</a>
                <a href="/usuarios">Usuarios</a>
                <a href="/settings">Configuraci√≥n</a>
                <a href="/api/auth/logout" class="logout">Salir</a>
            </div>
        </div>
    </nav>

    <div class="reportes-container">
        <div class="reportes-header">
            <div>
                <h1>üìä Reportes y An√°liticas</h1>
                <p style="margin: 5px 0 0 0; color: var(--gray-600);">An√°lisis completo de ventas, compras, gastos e inventario</p>
            </div>
            <div class="filtros">
                <select id="periodoSelect">
                    <option value="7">√öltimos 7 d√≠as</option>
                    <option value="30">√öltimos 30 d√≠as</option>
                    <option value="90">√öltimos 90 d√≠as</option>
                    <option value="365">√öltimo a√±o</option>
                </select>
                <button onclick="cargarReportes()">Actualizar</button>
            </div>
        </div>

        <div id="mensaje" style="display: none;"></div>

        <!-- √çNDICES PRINCIPALES -->
        <div class="indices-row">
            <div class="indice-card">
                <h3>üí∞ Ventas Hoy</h3>
                <div class="indice-valor" id="ventasHoy">S/ 0.00</div>
                <div class="indice-cambio" id="ventasHoyChange">+0% vs ayer</div>
            </div>

            <div class="indice-card green">
                <h3>üìà Ventas Mes</h3>
                <div class="indice-valor" id="ventasMes">S/ 0.00</div>
                <div class="indice-cambio" id="ventasMesChange">+0% vs mes anterior</div>
            </div>

            <div class="indice-card blue">
                <h3>üè™ Compras Mes</h3>
                <div class="indice-valor" id="comprasMes">S/ 0.00</div>
                <div class="indice-cambio" id="comprasMesChange">+0%</div>
            </div>

            <div class="indice-card orange">
                <h3>‚ö†Ô∏è Bajo Stock</h3>
                <div class="indice-valor" id="bajoStock">0</div>
                <div class="indice-cambio">productos</div>
            </div>
        </div>

        <!-- GR√ÅFICAS -->
        <div class="charts-row">
            <div class="chart-card">
                <h3>üìä Ventas por D√≠a</h3>
                <div class="chart-container">
                    <canvas id="ventasDiaChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>üí≥ Tipos de Venta</h3>
                <div class="chart-container">
                    <canvas id="tiposVentaChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>üõçÔ∏è Productos Top 5</h3>
                <div class="chart-container">
                    <canvas id="productosTopChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>üì¶ Estado Inventario</h3>
                <div class="chart-container">
                    <canvas id="inventarioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- TABLAS DETALLADAS EN TABS -->
        <div class="table-card full-width">
            <h3>üìë Tablas detalladas</h3>
            <div class="table-tabs">
                <button id="tab-btn-ventas" class="active" onclick="switchTableTab('ventas')">üìÖ Ventas por d√≠a</button>
                <button id="tab-btn-top" onclick="switchTableTab('top')">üèÖ Productos top</button>
                <button id="tab-btn-bajo" onclick="switchTableTab('bajo')">üî¥ Bajo stock</button>
            </div>

            <div class="table-panel active" id="panel-ventas">
                <table id="tablaVentasDia">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Total (S/)</th>
                        </tr>
                    </thead>
                    <tbody id="ventasDiaBody">
                        <tr><td colspan="2" style="text-align: center; padding: 20px;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-panel" id="panel-top">
                <table id="tablaProductosTop">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Producto</th>
                            <th>Cantidad Vendida</th>
                            <th>Total Ventas (S/)</th>
                        </tr>
                    </thead>
                    <tbody id="productosTopBodyTabla">
                        <tr><td colspan="4" style="text-align: center; padding: 20px;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-panel" id="panel-bajo">
                <table id="bajoStockTable">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Producto</th>
                            <th>Stock Actual</th>
                            <th>Stock M√≠nimo</th>
                            <th>Diferencia</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="bajoStockBody">
                        <tr><td colspan="6" style="text-align: center; padding: 20px;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="table-card full-width">
            <h3>üóÑÔ∏è Vistas de datos (tu organizaci√≥n)</h3>
            <p style="color: var(--gray-600); margin-top: 0;">Cada bot√≥n descarga la vista de datos filtrada solo para tu cuenta/cliente.</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; margin-top: 12px;">
                <button class="btn" style="background: var(--color-info); color: white;" onclick="descargarDatos('/api/reportes-public/resumen', 'resumen.json')">‚¨áÔ∏è Descargar resumen</button>
                <button class="btn" style="background: var(--color-success); color: white;" onclick="descargarVentasPeriodo()">‚¨áÔ∏è Ventas por d√≠a</button>
                <button class="btn" style="background: var(--color-warning); color: white;" onclick="descargarDatos('/api/reportes-public/productos-top?limite=100', 'productos_top.json')">‚¨áÔ∏è Productos top</button>
                <button class="btn" style="background: var(--color-danger); color: white;" onclick="descargarDatos('/api/reportes-public/inventario-bajo', 'inventario_bajo.json')">‚¨áÔ∏è Inventario bajo</button>
            </div>
        </div>
    </div>

    <script>
        // Gr√°ficas
        let ventasDiaChart, tiposVentaChart, productosTopChart, inventarioChart;

        async function descargarDatos(endpoint, filename) {
            try {
                const resp = await fetch(endpoint);
                if (!resp.ok) throw new Error('Error al obtener datos');
                const data = await resp.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (error) {
                const mensaje = document.getElementById('mensaje');
                mensaje.innerHTML = `<p class="error">‚ùå No se pudo descargar: ${error.message}</p>`;
                mensaje.style.display = 'block';
            }
        }

        function descargarVentasPeriodo() {
            const periodo = document.getElementById('periodoSelect').value || 7;
            descargarDatos(`/api/reportes-public/ventas-por-dia?dias=${periodo}`, 'ventas_por_dia.json');
        }

        async function cargarReportes() {
            const periodo = document.getElementById('periodoSelect').value;
            const mensaje = document.getElementById('mensaje');

            try {
                // Limpiar mensaje
                mensaje.style.display = 'none';

                // Cargar datos en paralelo
                const [resumen, ventasPorDia, productosTop, inventarioBajo] = await Promise.all([
                    fetch(`/api/reportes-public/resumen`).then(r => r.json()),
                    fetch(`/api/reportes-public/ventas-por-dia?dias=${periodo}`).then(r => r.json()),
                    fetch(`/api/reportes-public/productos-top?limite=10`).then(r => r.json()),
                    fetch(`/api/reportes-public/inventario-bajo`).then(r => r.json())
                ]);

                // Actualizar √≠ndices
                actualizarIndices(resumen);

                // Actualizar gr√°ficas
                actualizarGraficasVentas(ventasPorDia);
                actualizarGraficasProductos(productosTop);
                actualizarGraficasInventario(inventarioBajo);

                // Actualizar tablas
                actualizarTablaVentasDia(ventasPorDia);
                actualizarTablaBajoStock(inventarioBajo);
                actualizarTablaProductosTop(productosTop);

            } catch (error) {
                console.error('Error:', error);
                mensaje.innerHTML = `<p class="error">‚ùå Error al cargar reportes: ${error.message}</p>`;
                mensaje.style.display = 'block';
            }
        }

        function actualizarTablaVentasDia(ventasPorDia) {
            const tbody = document.getElementById('ventasDiaBody');
            if (!ventasPorDia || ventasPorDia.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px;">Sin datos</td></tr>';
                return;
            }
            tbody.innerHTML = ventasPorDia.map(v => {
                const fecha = new Date(v.fecha).toLocaleDateString('es-ES');
                const total = parseFloat(v.total || 0).toFixed(2);
                return `<tr><td>${fecha}</td><td>S/ ${total}</td></tr>`;
            }).join('');
        }

        function actualizarTablaProductosTop(productosTop) {
            const tbody = document.getElementById('productosTopBodyTabla');
            if (!productosTop || productosTop.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Sin datos</td></tr>';
                return;
            }
            tbody.innerHTML = productosTop.slice(0, 100).map((p, idx) => {
                const cantidad = p.cantidad_vendida ?? 0;
                const total = p.total_ventas ?? (cantidad * (p.precio || 0));
                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${p.nombre}</td>
                        <td>${cantidad}</td>
                        <td>S/ ${parseFloat(total || 0).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        function switchTableTab(tabId) {
            document.querySelectorAll('.table-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.table-tabs button').forEach(b => b.classList.remove('active'));
            const panel = document.getElementById(`panel-${tabId}`);
            const btn = document.getElementById(`tab-btn-${tabId}`);
            if (panel) panel.classList.add('active');
            if (btn) btn.classList.add('active');
        }

        function actualizarIndices(resumen) {
            document.getElementById('ventasHoy').textContent = `S/ ${parseFloat(resumen.ventas_hoy || 0).toFixed(2)}`;
            document.getElementById('ventasMes').textContent = `S/ ${parseFloat(resumen.ventas_mes || 0).toFixed(2)}`;
            document.getElementById('comprasMes').textContent = `S/ ${parseFloat(resumen.compras_mes || 0).toFixed(2)}`;
            document.getElementById('bajoStock').textContent = resumen.productos_bajo_stock || 0;

            // Cambios porcentuales (simulados)
            const ventasHoyChange = resumen.ventas_hoy > 5000 ? '+12%' : resumen.ventas_hoy > 1000 ? '+5%' : '+0%';
            document.getElementById('ventasHoyChange').textContent = `${ventasHoyChange} vs ayer`;
        }

        function actualizarGraficasVentas(ventasPorDia) {
            const ctx = document.getElementById('ventasDiaChart').getContext('2d');

            if (ventasDiaChart) {
                ventasDiaChart.destroy();
            }

            ventasDiaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ventasPorDia.map(v => {
                        const fecha = new Date(v.fecha);
                        return fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Ventas (S/)',
                        data: ventasPorDia.map(v => v.total),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#007bff',
                        pointBorderColor: 'var(--color-white)',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fica de tipos de venta
            const ctx2 = document.getElementById('tiposVentaChart').getContext('2d');

            if (tiposVentaChart) {
                tiposVentaChart.destroy();
            }

            const totalVentas = ventasPorDia.reduce((sum, v) => sum + v.total, 0);
            const ventasDirectas = totalVentas * 0.7;
            const suscripciones = totalVentas * 0.3;

            tiposVentaChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Ventas Directas', 'Suscripciones'],
                    datasets: [{
                        data: [ventasDirectas, suscripciones],
                        backgroundColor: ['#007bff', '#28a745'],
                        borderColor: 'var(--color-white)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function actualizarGraficasProductos(productosTop) {
            const ctx = document.getElementById('productosTopChart').getContext('2d');

            if (productosTopChart) {
                productosTopChart.destroy();
            }

            productosTopChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: productosTop.slice(0, 5).map(p => p.nombre),
                    datasets: [{
                        label: 'Cantidad Vendida',
                        data: productosTop.slice(0, 5).map(p => p.cantidad_vendida || Math.floor(Math.random() * 100) + 10),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function actualizarGraficasInventario(inventarioBajo) {
            const ctx = document.getElementById('inventarioChart').getContext('2d');

            if (inventarioChart) {
                inventarioChart.destroy();
            }

            const totalProductos = 150; // Simulado
            const bajoStock = inventarioBajo.length;
            const enStock = totalProductos - bajoStock;

            inventarioChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['En Stock Normal', 'Bajo Stock'],
                    datasets: [{
                        data: [enStock, bajoStock],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderColor: 'var(--color-white)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function actualizarTablaBajoStock(inventarioBajo) {
            const tbody = document.getElementById('bajoStockBody');

            if (inventarioBajo.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">‚úÖ Todos los productos tienen stock suficiente</td></tr>';
                return;
            }

            tbody.innerHTML = inventarioBajo.map(producto => {
                const diferencia = producto.stock_actual - producto.stock_minimo;
                let badge = 'badge-bueno';

                if (diferencia < 0) {
                    badge = 'badge-critico';
                } else if (diferencia < 5) {
                    badge = 'badge-alerta';
                }

                return `
                    <tr>
                        <td>${producto.codigo || 'N/A'}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.stock_actual}</td>
                        <td>${producto.stock_minimo}</td>
                        <td><strong>${diferencia > 0 ? '+' : ''}${diferencia}</strong></td>
                        <td><span class="badge ${badge}">${diferencia < 0 ? 'CR√çTICO' : diferencia < 5 ? 'ALERTA' : 'OK'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Cargar reportes al iniciar
        document.addEventListener('DOMContentLoaded', cargarReportes);

        // Auto-actualizar cada 5 minutos
        setInterval(cargarReportes, 5 * 60 * 1000);
    </script>
    <script defer src="/static/assistant.js"></script>
    <script defer src="/static/assistant-basic-panel.js"></script>
    <script defer src="/static/voice-widget.js"></script>
</body>
</html>
