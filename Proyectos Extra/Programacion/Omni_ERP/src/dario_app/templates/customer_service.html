<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Service - OmniERP</title>
    <link rel="stylesheet" href="/static/global.css">
    <link rel="stylesheet" href="/static/components.css">
    <link rel="stylesheet" href="/static/assistant.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root { /* Using global design tokens; no local overrides */ }
        * { box-sizing: border-box; }
        body { margin:0; font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); }
        header { display:flex; justify-content:space-between; align-items:center; padding:20px 28px; border-bottom:1px solid var(--border-color); backdrop-filter: blur(8px); position:sticky; top:0; z-index:10; background: var(--bg-secondary); }
        .logo { font-weight:700; color: var(--brand-primary); letter-spacing:.8px; display:flex; align-items:center; gap:8px; }
        .nav a { color:var(--text-secondary); text-decoration:none; margin-left:14px; padding:8px 12px; border-radius:10px; border:1px solid transparent; }
        .nav a:hover { border-color:var(--border-color); background: inherit; }
        main { max-width:1400px; margin:0 auto; padding:24px; }
        h1 { margin:0; font-size:30px; letter-spacing:-0.5px; }
        p.lead { margin:8px 0 18px; color: var(--text-secondary); max-width:900px; }
        .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(340px,1fr)); }
        .card { background: var(--bg-tertiary); border:1px solid var(--border-color); border-radius:14px; padding:18px; box-shadow:0 18px 40px rgba(0,0,0,0.1); position:relative; }
        .card h2 { margin:0 0 10px; font-size:18px; color:var(--text-primary); display:flex; align-items:center; gap:8px; }
        .card p.desc { margin:0 0 12px; color: var(--text-secondary); font-size:14px; opacity:0.9; }
        label { display:block; margin-bottom:6px; color:var(--text-secondary); font-weight:600; font-size:13px; }
        input, select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary); font-size:14px; }
        input:focus, select:focus, textarea:focus { outline:2px solid var(--brand-primary-light); }
        textarea { min-height:80px; resize:vertical; }
        .row { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:10px; }
        .list { border:1px solid var(--border-color); border-radius:12px; padding:10px; max-height:280px; overflow-y:auto; background:var(--bg-tertiary); }
        .list-item { padding:8px 6px; border-bottom:1px solid var(--border-color); font-size:13px; cursor:pointer; }
        .list-item:last-child { border-bottom:none; }
        .list-item:hover { background: inherit; }
        .pill { padding:4px 8px; border-radius:8px; background:var(--primary-light); color:var(--brand-primary); font-size:12px; display:inline-block; margin-right:6px; }
        .pill.urgent { background:var(--color-danger-light); color:var(--color-danger); }
        .pill.high { background:var(--color-warning-light); color:var(--color-warning); }
        .pill.blue { background:var(--color-info-light); color:var(--color-info); }
        .pill.amber { background:var(--color-warning-light); color:var(--color-warning); }
        button { border:none; background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-dark) 100%); color:var(--text-inverse); padding:0 var(--spacing-lg); height: 40px; border-radius:12px; font-weight:700; cursor:pointer; margin-top:10px; width:100%; transition: none; }
        button.secondary { background:transparent; color:var(--text-primary); border:1px solid var(--border-color); }
        button:hover { transform: none; }
        .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--bg-tertiary); border:1px solid var(--border-color); font-size:12px; }
        .tabs { display:flex; gap:8px; margin-bottom:12px; border-bottom:1px solid var(--border-color); }
        .tab { padding:10px 16px; cursor:pointer; color:var(--text-tertiary); border-bottom:2px solid transparent; }
        .tab.active { color: var(--brand-primary); border-bottom-color: var(--brand-primary); }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .stack { display:flex; gap:10px; flex-wrap:wrap; }
        .inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        @media (max-width:720px){ header { flex-direction:column; align-items:flex-start; gap:8px; } main { padding:16px; } }
    </style>
    <link rel="stylesheet" href="/static/modules-base.css">
    <link rel="stylesheet" href="/static/components-advanced.css">
</head>
<body>
    {% include '_assistant_panel.html' %}
<header>
    <div class="logo">üéß Customer Service</div>
    <div class="nav">
        <a href="/app/dashboard">‚Üê Dashboard</a>
        <a href="/api/docs">API</a>
    </div>
</header>

<main>
    <h1>Soporte y Knowledge Base</h1>
    <p class="lead">Gestiona casos, responde consultas, construye tu base de conocimientos y asigna entitlements de soporte.</p>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('cases')">üìã Casos</div>
        <div class="tab" onclick="switchTab('kb')">üìö Knowledge Base</div>
        <div class="tab" onclick="switchTab('entitlements')">üé´ Entitlements</div>
    </div>

    <!-- Cases Tab -->
    <div class="tab-content active" id="tab-cases">
        <div class="grid">
            <div class="card">
                <h2>üé´ Nuevo caso</h2>
                <p class="desc">Alta r√°pida de ticket con prioridad y SLA.</p>
                <div class="row">
                    <div><label>T√≠tulo</label><input id="caseTitle" placeholder="Cliente no puede acceder"></div>
                    <div><label>Prioridad</label>
                        <select id="casePriority">
                            <option value="low">Baja</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">Alta</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div><label>Severidad</label>
                        <select id="caseSeverity">
                            <option value="minor" selected>Menor</option>
                            <option value="moderate">Moderada</option>
                            <option value="major">Mayor</option>
                            <option value="critical">Cr√≠tica</option>
                        </select>
                    </div>
                    <div><label>Categor√≠a</label><input id="caseCategory" placeholder="technical, billing..."></div>
                </div>
                <div class="row">
                    <div><label>Cliente</label><input id="caseCustomer" placeholder="Nombre"></div>
                    <div><label>Email contacto</label><input id="caseEmail" type="email"></div>
                </div>
                <label>Descripci√≥n</label>
                <textarea id="caseDesc" placeholder="Detalle del problema"></textarea>
                <button onclick="createCase()">Crear caso</button>
            </div>

            <div class="card">
                <h2>üìã Casos activos</h2>
                <p class="desc">Selecciona para ver detalles y comentarios.</p>
                <div class="stack" style="margin-bottom:8px;">
                    <select id="filterStatus" onchange="loadCases()" style="flex:1;"><option value="">Todos</option><option value="new">Nuevos</option><option value="active">Activos</option><option value="resolved">Resueltos</option></select>
                    <select id="filterPriority" onchange="loadCases()" style="flex:1;"><option value="">Todas prioridades</option><option value="urgent">Urgente</option><option value="high">Alta</option></select>
                </div>
                <div class="list" id="caseList"></div>
            </div>

            <div class="card">
                <h2>üí¨ Detalles del caso</h2>
                <p class="desc" id="caseDetailTitle">Selecciona un caso para ver detalles.</p>
                <div class="stack" style="margin-bottom:8px;">
                    <span class="chip">Caso: <strong id="caseNum">‚Äî</strong></span>
                    <span class="chip">Estado: <span id="caseStatus">‚Äî</span></span>
                </div>
                <div class="row" style="margin-bottom:8px;">
                    <select id="updateStatus"><option value="new">Nuevo</option><option value="active">Activo</option><option value="resolved">Resuelto</option><option value="closed">Cerrado</option></select>
                    <button class="secondary" onclick="updateCaseStatus()" style="width:auto; margin-top:0;">Actualizar estado</button>
                </div>
                <div class="inline" style="margin-bottom:8px;">
                    <input id="assignUser" type="number" placeholder="User ID" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                    <input id="assignName" placeholder="Nombre" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                    <button class="secondary" onclick="assignCase()" style="width:auto; margin-top:0;">Asignar</button>
                </div>
                <button class="secondary" onclick="escalateCase()">‚ö†Ô∏è Escalar a gerencia</button>
                <div class="list" id="commentList" style="margin-top:10px; max-height:140px;"></div>
                <label style="margin-top:8px;">A√±adir comentario</label>
                <textarea id="commentText" placeholder="Respuesta o nota interna"></textarea>
                <label><input type="checkbox" id="commentInternal"> Nota interna (no visible para cliente)</label>
                <button class="secondary" onclick="addComment()">Enviar comentario</button>
            </div>
        </div>
    </div>

    <!-- KB Tab -->
    <div class="tab-content" id="tab-kb">
        <div class="grid">
            <div class="card">
                <h2>üìù Nuevo art√≠culo</h2>
                <p class="desc">Crea documentaci√≥n self-service.</p>
                <div class="row">
                    <div><label>T√≠tulo</label><input id="kbTitle" placeholder="C√≥mo resetear contrase√±a"></div>
                    <div><label>Categor√≠a</label><input id="kbCategory" placeholder="FAQ, tutorial..."></div>
                </div>
                <label>Resumen</label>
                <textarea id="kbSummary" placeholder="Breve descripci√≥n" style="min-height:50px;"></textarea>
                <label>Contenido</label>
                <textarea id="kbContent" placeholder="Paso a paso detallado" style="min-height:120px;"></textarea>
                <label>Keywords (separadas por comas)</label>
                <input id="kbKeywords" placeholder="password, reset, olvid√©">
                <button onclick="createArticle()">Crear art√≠culo</button>
            </div>

            <div class="card">
                <h2>üìö Art√≠culos</h2>
                <p class="desc">Busca y publica art√≠culos.</p>
                <div class="inline" style="margin-bottom:8px;">
                    <input id="searchKB" placeholder="Buscar..." style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);" onkeyup="if(event.key==='Enter') searchArticles()">
                    <button class="secondary" onclick="searchArticles()" style="width:auto; margin-top:0;">üîç</button>
                </div>
                <div class="list" id="kbList"></div>
            </div>

            <div class="card">
                <h2>üëÅÔ∏è Detalle art√≠culo</h2>
                <p class="desc" id="kbDetailTitle">Selecciona para ver contenido.</p>
                <div class="stack" style="margin-bottom:8px;">
                    <span class="chip">N√∫mero: <strong id="kbNum">‚Äî</strong></span>
                    <span class="chip">Estado: <span id="kbStatusDetail">‚Äî</span></span>
                    <span class="chip">Vistas: <span id="kbViews">0</span></span>
                </div>
                <div id="kbContentDetail" style="padding:12px; background:rgba(255,255,255,0.02); border-radius:10px; max-height:200px; overflow-y:auto; margin-bottom:8px; font-size:13px; line-height:1.6;"></div>
                <div class="inline">
                    <button class="secondary" onclick="publishArticle()" style="flex:1;">‚úÖ Publicar</button>
                    <button class="secondary" onclick="articleFeedback(true)" style="width:auto;">üëç</button>
                    <button class="secondary" onclick="articleFeedback(false)" style="width:auto;">üëé</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Entitlements Tab -->
    <div class="tab-content" id="tab-entitlements">
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));">
            <div class="card">
                <h2>üé´ Nuevo entitlement</h2>
                <p class="desc">Contrato de soporte con incidentes/horas.</p>
                <div class="row">
                    <div><label>Nombre</label><input id="entName" placeholder="Soporte Gold 2025"></div>
                    <div><label>Cliente ID</label><input id="entCustomer" type="number"></div>
                </div>
                <div class="row">
                    <div><label>Inicio</label><input id="entStart" type="date"></div>
                    <div><label>Fin</label><input id="entEnd" type="date"></div>
                </div>
                <div class="row">
                    <div><label>Tipo</label>
                        <select id="entType">
                            <option value="incidents">Incidentes</option>
                            <option value="hours">Horas</option>
                            <option value="unlimited">Ilimitado</option>
                        </select>
                    </div>
                    <div><label>Total incidentes</label><input id="entIncidents" type="number"></div>
                    <div><label>Total horas</label><input id="entHours" type="number" step="0.5"></div>
                </div>
                <button onclick="createEntitlement()">Crear entitlement</button>
            </div>

            <div class="card">
                <h2>üé´ Entitlements activos</h2>
                <p class="desc">Contratos vigentes y consumo.</p>
                <div class="list" id="entList"></div>
            </div>
        </div>
    </div>
</main>

<script>
let currentCase = null;
let currentArticle = null;

const api = async (url, options={}) => {
    const opts = Object.assign({credentials:'include', headers:{'Content-Type':'application/json'}}, options);
    const resp = await fetch(url, opts);
    if(!resp.ok){ const t = await resp.text(); throw new Error(t || resp.statusText); }
    const ct = resp.headers.get('content-type')||''; return ct.includes('application/json') ? resp.json() : resp.text();
};

function switchTab(tab){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('tab-'+tab).classList.add('active');
    if(tab==='cases') loadCases();
    if(tab==='kb') loadArticles();
    if(tab==='entitlements') loadEntitlements();
}

// Cases
async function createCase(){
    try {
        const data = await api('/api/customer-service/cases',{method:'POST',body:JSON.stringify({
            title: document.getElementById('caseTitle').value,
            descripcion: document.getElementById('caseDesc').value || null,
            customer_name: document.getElementById('caseCustomer').value || null,
            contact_email: document.getElementById('caseEmail').value || null,
            priority: document.getElementById('casePriority').value,
            severity: document.getElementById('caseSeverity').value,
            category: document.getElementById('caseCategory').value || null
        })});
        setCase(data.id, data.case_number, data.title, data.status);
        loadCases();
    } catch(e){ alert(e.message); }
}

async function loadCases(){
    const status = document.getElementById('filterStatus')?.value;
    const priority = document.getElementById('filterPriority')?.value;
    let url = '/api/customer-service/cases?';
    if(status) url += `status=${status}&`;
    if(priority) url += `priority=${priority}&`;
    try {
        const data = await api(url);
        const list = document.getElementById('caseList');
        list.innerHTML = data.map(c => `<div class="list-item" onclick="setCase(${c.id}, '${c.case_number}', '${c.title}', '${c.status}')"><div><span class="pill ${c.priority==='urgent'?'urgent':(c.priority==='high'?'high':'')}">${c.priority}</span><strong>${c.case_number}</strong> ¬∑ ${c.title}</div><small style="color: var(--text-tertiary);">${c.customer_name || '‚Äî'} ¬∑ ${c.status}</small></div>`).join('') || '<div class="list-item" style="color: var(--text-tertiary)">Sin casos</div>';
    } catch(e){ document.getElementById('caseList').innerHTML = `<div class='list-item' style='color:var(--color-danger)'>${e.message}</div>`; }
}

function setCase(id, num, title, status){
    currentCase = id;
    document.getElementById('caseNum').textContent = num;
    document.getElementById('caseStatus').textContent = status;
    document.getElementById('caseDetailTitle').textContent = title;
    document.getElementById('updateStatus').value = status;
    loadComments();
}

async function updateCaseStatus(){
    if(!currentCase) return alert('Selecciona caso');
    try {
        await api(`/api/customer-service/cases/${currentCase}`,{method:'PATCH',body:JSON.stringify({status:document.getElementById('updateStatus').value})});
        loadCases();
    } catch(e){ alert(e.message); }
}

async function assignCase(){
    if(!currentCase) return alert('Selecciona caso');
    try {
        await api(`/api/customer-service/cases/${currentCase}`,{method:'PATCH',body:JSON.stringify({
            assigned_to_user_id: document.getElementById('assignUser').value ? Number(document.getElementById('assignUser').value) : null,
            assigned_to_name: document.getElementById('assignName').value || null
        })});
        loadCases();
    } catch(e){ alert(e.message); }
}

async function escalateCase(){
    if(!currentCase) return alert('Selecciona caso');
    const name = prompt('Escalar a (nombre):');
    if(!name) return;
    try {
        await api(`/api/customer-service/cases/${currentCase}/escalate?escalated_to_name=${encodeURIComponent(name)}`,{method:'POST'});
        loadCases();
    } catch(e){ alert(e.message); }
}

async function addComment(){
    if(!currentCase) return alert('Selecciona caso');
    try {
        await api(`/api/customer-service/cases/${currentCase}/comments`,{method:'POST',body:JSON.stringify({
            comment: document.getElementById('commentText').value,
            is_internal: document.getElementById('commentInternal').checked
        })});
        document.getElementById('commentText').value = '';
        document.getElementById('commentInternal').checked = false;
        loadComments();
    } catch(e){ alert(e.message); }
}

async function loadComments(){
    if(!currentCase){ document.getElementById('commentList').innerHTML = '<div class="list-item" style="color:var(--text-secondary)">Selecciona caso</div>'; return; }
    try {
        const data = await api(`/api/customer-service/cases/${currentCase}/comments`);
        const list = document.getElementById('commentList');
        list.innerHTML = data.map(c => `<div class="list-item">${c.is_internal?'<span class="pill amber">Interno</span>':''}<strong>${c.author_name || 'Usuario'}</strong>: ${c.comment}<br><small style="color: var(--text-tertiary);">${new Date(c.created_at).toLocaleString()}</small></div>`).join('') || '<div class="list-item" style="color: var(--text-tertiary)">Sin comentarios</div>';
    } catch(e){ document.getElementById('commentList').innerHTML = `<div class='list-item' style='color:var(--color-danger)'>${e.message}</div>`; }
}

// KB
async function createArticle(){
    try {
        const data = await api('/api/customer-service/kb/articles',{method:'POST',body:JSON.stringify({
            title: document.getElementById('kbTitle').value,
            content: document.getElementById('kbContent').value,
            summary: document.getElementById('kbSummary').value || null,
            category: document.getElementById('kbCategory').value || null,
            keywords: document.getElementById('kbKeywords').value || null
        })});
        setArticle(data.id, data.article_number, data.title, data.content, data.status, data.view_count);
        loadArticles();
    } catch(e){ alert(e.message); }
}

async function loadArticles(){
    try {
        const data = await api('/api/customer-service/kb/articles');
        const list = document.getElementById('kbList');
        list.innerHTML = data.map(a => `<div class="list-item" onclick="setArticle(${a.id}, '${a.article_number}', \`${a.title}\`, \`${a.content}\`, '${a.status}', ${a.view_count})"><span class="pill ${a.status==='published'?'':'blue'}">${a.status}</span><strong>${a.article_number}</strong> ¬∑ ${a.title}<br><small style="color: var(--text-tertiary);">${a.category || '‚Äî'} ¬∑ Vistas: ${a.view_count}</small></div>`).join('') || '<div class="list-item" style="color: var(--text-tertiary)">Sin art√≠culos</div>';
    } catch(e){ document.getElementById('kbList').innerHTML = `<div class='list-item' style='color:var(--color-danger)'>${e.message}</div>`; }
}

async function searchArticles(){
    const search = document.getElementById('searchKB').value;
    try {
        const data = await api(`/api/customer-service/kb/articles?search=${encodeURIComponent(search)}`);
        const list = document.getElementById('kbList');
        list.innerHTML = data.map(a => `<div class="list-item" onclick="setArticle(${a.id}, '${a.article_number}', \`${a.title}\`, \`${a.content}\`, '${a.status}', ${a.view_count})"><span class="pill ${a.status==='published'?'':'blue'}">${a.status}</span><strong>${a.article_number}</strong> ¬∑ ${a.title}</div>`).join('') || '<div class="list-item" style="color:var(--muted)">Sin resultados</div>';
    } catch(e){ document.getElementById('kbList').innerHTML = `<div class='list-item' style='color:var(--color-danger)'>${e.message}</div>`; }
}

function setArticle(id, num, title, content, status, views){
    currentArticle = id;
    document.getElementById('kbNum').textContent = num;
    document.getElementById('kbStatusDetail').textContent = status;
    document.getElementById('kbViews').textContent = views;
    document.getElementById('kbDetailTitle').textContent = title;
    document.getElementById('kbContentDetail').textContent = content;
}

async function publishArticle(){
    if(!currentArticle) return alert('Selecciona art√≠culo');
    try {
        await api(`/api/customer-service/kb/articles/${currentArticle}/publish`,{method:'POST'});
        loadArticles();
    } catch(e){ alert(e.message); }
}

async function articleFeedback(helpful){
    if(!currentArticle) return alert('Selecciona art√≠culo');
    try {
        const data = await api(`/api/customer-service/kb/articles/${currentArticle}/feedback?helpful=${helpful}`,{method:'POST'});
        document.getElementById('kbViews').textContent = data.helpful_count + data.not_helpful_count;
    } catch(e){ alert(e.message); }
}

// Entitlements
async function createEntitlement(){
    try {
        const data = await api('/api/customer-service/entitlements',{method:'POST',body:JSON.stringify({
            name: document.getElementById('entName').value,
            customer_id: document.getElementById('entCustomer').value ? Number(document.getElementById('entCustomer').value) : null,
            start_date: document.getElementById('entStart').value,
            end_date: document.getElementById('entEnd').value,
            entitlement_type: document.getElementById('entType').value,
            total_incidents: document.getElementById('entIncidents').value ? Number(document.getElementById('entIncidents').value) : null,
            total_hours: document.getElementById('entHours').value ? Number(document.getElementById('entHours').value) : null
        })});
        loadEntitlements();
    } catch(e){ alert(e.message); }
}

async function loadEntitlements(){
    try {
        const data = await api('/api/customer-service/entitlements');
        const list = document.getElementById('entList');
        list.innerHTML = data.map(e => `<div class="list-item"><div><span class="pill">${e.entitlement_type}</span><strong>${e.entitlement_number}</strong> ¬∑ ${e.name}</div><small style="color: var(--text-tertiary);">${e.customer_name || '‚Äî'} ¬∑ ${e.start_date} a ${e.end_date}<br>Usado: ${e.used_incidents || 0}/${e.total_incidents || '‚àû'} incidentes ¬∑ ${e.used_hours || 0}/${e.total_hours || '‚àû'}h</small></div>`).join('') || '<div class="list-item" style="color: var(--text-tertiary)">Sin entitlements</div>';
    } catch(e){ document.getElementById('entList').innerHTML = `<div class='list-item' style='color:var(--color-danger)'>${e.message}</div>`; }
}

// Init
loadCases();
</script>
    <script defer src="/static/assistant.js"></script>
    <script defer src="/static/assistant-basic-panel.js"></script>
    <script defer src="/static/voice-widget.js"></script>
</body>
</html>
